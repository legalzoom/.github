name: CD for .NET applications

on:
  push:
    branches:
      - $default-branch

permissions:
  contents: write
  id-token: write
  checks: write
  statuses: write

jobs:
  test:
    uses: legalzoom/gha-workflows/.github/workflows/dotnet-test.yaml@main
    with:
      restore-target: ./change/me
      test-target: ./change/me
      
  build-and-push:
    uses: legalzoom/gha-workflows/.github/workflows/docker-build-and-push.yaml@main

  deploy-to-k8s-dev:
    name: Deploy to Kubernetes
    needs: [ build-and-push ]
    uses: legalzoom/gha-workflows/.github/workflows/deploy-to-k8s.yaml@main
    with:
      stage-name: "dev"

  deploy-to-k8s-qa:
    name: Deploy to Kubernetes
    needs: [ build-and-push ]
    uses: legalzoom/gha-workflows/.github/workflows/deploy-to-k8s.yaml@main
    with:
      stage-name: "qa"

  deploy-to-k8s-prd:
    name: Deploy to Kubernetes
    needs: [ deploy-to-k8s-qa ]
    uses: legalzoom/gha-workflows/.github/workflows/deploy-to-k8s.yaml@main
    with:
      stage-name: "prd"
